name: badges
on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

env:
  BASE_IMAGE: openpilot-base
  RUN: export UV_BIN="/home/runner/.local/bin" ; export PATH="$UV_BIN:$PATH" ; source /home/runner/.venv/bin/activate || true ; export PYTHONPATH=/tmp/openpilot ; export CI=1 ; export PYTHONWARNINGS=error ; export FILEREADER_CACHE=1 ; bash -c

jobs:
  setup-cache:
    name: setup cache
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      # build scons cache
      - id: date
        shell: bash
        run: echo "CACHE_COMMIT_DATE=$(git log -1 --pretty='format:%cd' --date=format:'%Y-%m-%d-%H:%M')" >> $GITHUB_ENV
      - shell: bash
        run: echo "$CACHE_COMMIT_DATE"
      - id: scons-cache
        uses: ./.github/workflows/auto-cache
        with:
          path: .ci_cache/scons_cache
          key: scons-${{ runner.arch }}-${{ env.CACHE_COMMIT_DATE }}-${{ github.sha }}
          restore-keys: |
            scons-${{ runner.arch }}-${{ env.CACHE_COMMIT_DATE }}
            scons-${{ runner.arch }}
      - name: setup-with-retry
        uses: ./.github/workflows/setup-with-retry
  badges:
    name: create badges
    runs-on: ubuntu-latest
    if: github.repository == 'commaai/openpilot'
    permissions:
      contents: write
    needs: [setup-cache]
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
    - uses: ./.github/workflows/setup-with-retry
    - name: Push badges
      run: |
        ${{ env.RUN }} "scons -j$(nproc) && python3 selfdrive/ui/translations/create_badges.py"

        rm .gitattributes

        git checkout --orphan badges
        git rm -rf --cached .
        git config user.email "badge-researcher@comma.ai"
        git config user.name "Badge Researcher"

        git add translation_badge.svg
        git commit -m "Add/Update badges"
        git push -f origin HEAD
